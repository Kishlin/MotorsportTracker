package infrastructure

import (
	"context"
	"net/http"
	"net/http/httptest"
	"regexp"

	client "github.com/kishlin/MotorsportTracker/src/Golang/shared/client/infrastructure"
)

const series = `[{"name":"FIA Formula One World Championship","uuid":"a33f8b4a-2b22-41ce-8e7d-0aea08f0e176","shortName":"Formula 1","shortCode":"F1","category":"Single Seater"},{"name":"FIA World Endurance Championship","uuid":"967cd5ab-5562-40dc-a0b0-109738adcd01","shortName":"World Endurance Cham","shortCode":"WEC","category":"Sportscar"},{"name":"FIM MotoGP World Championship","uuid":"a485d01c-f907-4ff7-83db-ca1c90cc28a1","shortName":null,"shortCode":"MotoGP","category":"Motorcycle"}]`

var seasons = map[string]string{
	"a33f8b4a-2b22-41ce-8e7d-0aea08f0e176": `[{"name":"2025 World Championship","uuid":"71fdf79a-0cf3-4aab-99f6-b9a836c333da","year":2025,"endYear":2025,"status":""},{"name":"2024 World Championship","uuid":"afc5ab1b-c44b-4c21-904d-215fcc800578","year":2024,"endYear":2024,"status":"Current"},{"name":"2023 World Championship","uuid":"bbe13c43-7cc2-4cca-90a0-9268e98ff6e3","year":2023,"endYear":2023,"status":"Historic"}]`,
	"967cd5ab-5562-40dc-a0b0-109738adcd01": `[{"name":"2025 World Endurance Championship","uuid":"204926ca-77b0-4a4f-a1e7-352152e4fc25","year":2025,"endYear":2025,"status":"Current"},{"name":"2024 World Endurance Championship","uuid":"57eeab02-e71c-412d-aec6-e524ac622d63","year":2024,"endYear":2024,"status":"Historic"}]`,
	"a485d01c-f907-4ff7-83db-ca1c90cc28a1": `[{"name":"2025 World Championship","uuid":"52773acf-a477-409a-9d23-e31bd26e25f1","year":2025,"endYear":2025,"status":"Current"},{"name":"2024 World Championship","uuid":"6135c23f-bb6e-4b2b-a276-cc9011a424fa","year":2024,"endYear":2024,"status":"Historic"}]`,
}

var calendar = map[string]string{
	"71fdf79a-0cf3-4aab-99f6-b9a836c333da": `{"season":{"name":"2025 World Championship","uuid":"71fdf79a-0cf3-4aab-99f6-b9a836c333da","year":2025,"endYear":2025},"events":[{"uuid":"3076d943-d03f-4e2a-8518-64e852c927d1","name":"Australian Grand Prix","shortName":"Australian GP","shortCode":"AUS","status":"","startDate":1741910400,"startTimeUtc":1741870800,"endDate":1742083200,"endTimeUtc":1742130000,"venue":{"name":"Melbourne Grand Prix Circuit","uuid":"cc0117d2-7b7a-46f9-9714-7a336cdf960e","shortName":"Albert Park","shortCode":"MEL","picture":null},"country":{"name":"Australia","uuid":"5d247133-491d-4589-ab00-13d66211768b","picture":"https://assets.motorsportstats.com/flags/svg/au.svg"},"sessions":[{"uuid":"49e1cec7-b721-4ae0-b64e-f6e56f57d42a","name":"1st Free Practice","shortName":"Practice 1","shortCode":"P1","status":"","hasResults":true,"startTime":1741955400,"startTimeUtc":1741915800,"endTime":1741959000,"endTimeUtc":1741919400},{"uuid":"901416d0-ab91-40e3-88ba-28e20c0aad87","name":"2nd Free Practice","shortName":"Practice 2","shortCode":"P2","status":"","hasResults":true,"startTime":1741968000,"startTimeUtc":1741928400,"endTime":1741971600,"endTimeUtc":1741932000},{"uuid":"5bd0d80f-d7e4-43b1-88c9-30a98d8deb44","name":"3rd Free Practice","shortName":"Practice 3","shortCode":"P3","status":"","hasResults":true,"startTime":1742041800,"startTimeUtc":1742002200,"endTime":1742045400,"endTimeUtc":1742005800},{"uuid":"ff2bda66-24f0-4837-8b8b-30ca0a955b6b","name":"1st Qualifying","shortName":"Qualifying 1","shortCode":"Q1","status":"","hasResults":true,"startTime":1742054400,"startTimeUtc":1742014800,"endTime":1742055480,"endTimeUtc":1742015880},{"uuid":"e4b0e551-ccdb-4569-bfef-e914f3e57691","name":"2nd Qualifying","shortName":"Qualifying 2","shortCode":"Q2","status":"","hasResults":true,"startTime":1742055900,"startTimeUtc":1742016300,"endTime":1742056800,"endTimeUtc":1742017200},{"uuid":"8dca3ccd-2c3b-49c7-bc29-2c4cd7bb812c","name":"3rd Qualifying","shortName":"Qualifying 3","shortCode":"Q3","status":"","hasResults":true,"startTime":1742057280,"startTimeUtc":1742017680,"endTime":1742058000,"endTimeUtc":1742018400},{"uuid":"5f27995f-c280-4b5d-9f15-9978cbe936bc","name":"Combined Qualifying","shortName":"Qualifying","shortCode":"Q","status":"","hasResults":true,"startTime":1741996800,"startTimeUtc":1741957200,"endTime":null,"endTimeUtc":null},{"uuid":"6c24d47d-cb93-48e7-afbf-6a0389b829e4","name":"Race","shortName":"Race","shortCode":"Race","status":"","hasResults":true,"startTime":1742137200,"startTimeUtc":1742097600,"endTime":1742144400,"endTimeUtc":1742104800}]},{"uuid":"a45be211-6121-4b88-834e-ba447d2eb0b7","name":"Chinese Grand Prix","shortName":"China GP","shortCode":"CHN","status":"","startDate":1742515200,"startTimeUtc":1742486400,"endDate":1742688000,"endTimeUtc":1742745600,"venue":{"name":"Shanghai International Circuit","uuid":"adb703d8-45ea-4dcc-a13f-a48a5f652748","shortName":"Shanghai","shortCode":"SHA","picture":null},"country":{"name":"China","uuid":"c08bdf58-c105-4902-8ce4-3334f189d136","picture":"https://assets.motorsportstats.com/flags/svg/cn.svg"},"sessions":[{"uuid":"2137c4a7-5922-4c94-9a44-9d3cc07f86c9","name":"1st Free Practice","shortName":"Practice 1","shortCode":"P1","status":"","hasResults":true,"startTime":1742556600,"startTimeUtc":1742527800,"endTime":1742560200,"endTimeUtc":1742531400},{"uuid":"10ada0a2-9d68-4b5c-9ca8-c8d8e7e3aef5","name":"1st Sprint Qualifying","shortName":"Sprint Shootout 1","shortCode":"SQ1","status":"","hasResults":true,"startTime":1742571000,"startTimeUtc":1742542200,"endTime":1742571720,"endTimeUtc":1742542920},{"uuid":"253eb214-fda7-4f5e-8a50-642997d148d8","name":"2nd Sprint Qualifying","shortName":"Sprint Shootout 2","shortCode":"SQ2","status":"","hasResults":true,"startTime":1742572200,"startTimeUtc":1742543400,"endTime":1742572800,"endTimeUtc":1742544000},{"uuid":"8e4667ed-19c5-40c8-aa1d-38fc09b3a6c8","name":"3rd Sprint Qualifying","shortName":"Sprint Shootout 3","shortCode":"SQ3","status":"","hasResults":true,"startTime":1742573160,"startTimeUtc":1742544360,"endTime":1742573640,"endTimeUtc":1742544840},{"uuid":"e76fa061-8b74-494e-a6c7-024d5fcc761c","name":"Combined Sprint Qualifying","shortName":"Sprint Shootout","shortCode":"SQ","status":"","hasResults":true,"startTime":1742515200,"startTimeUtc":1742486400,"endTime":null,"endTimeUtc":null},{"uuid":"f50563fa-5a19-41eb-87bf-a5913d8ac229","name":"Sprint","shortName":"Sprint","shortCode":"SR","status":"","hasResults":true,"startTime":1742641200,"startTimeUtc":1742612400,"endTime":1742643000,"endTimeUtc":1742614200},{"uuid":"eeccc2d1-bed3-4af2-848b-5f2c2079624c","name":"1st Qualifying","shortName":"Qualifying 1","shortCode":"Q1","status":"","hasResults":true,"startTime":1742655600,"startTimeUtc":1742626800,"endTime":1742656680,"endTimeUtc":1742627880},{"uuid":"2cb0f2c0-7a34-405a-b851-7cd23f6aba8f","name":"2nd Qualifying","shortName":"Qualifying 2","shortCode":"Q2","status":"","hasResults":true,"startTime":1742657100,"startTimeUtc":1742628300,"endTime":1742658000,"endTimeUtc":1742629200},{"uuid":"e22e9c9b-8262-4029-8df2-4044238a4fc9","name":"3rd Qualifying","shortName":"Qualifying 3","shortCode":"Q3","status":"","hasResults":true,"startTime":1742658480,"startTimeUtc":1742629680,"endTime":1742659200,"endTimeUtc":1742630400},{"uuid":"0d4154cc-2b05-4882-ad65-c97ec24a3c48","name":"Combined Qualifying","shortName":"Qualifying","shortCode":"Q","status":"","hasResults":true,"startTime":1742601600,"startTimeUtc":1742572800,"endTime":null,"endTimeUtc":null},{"uuid":"443b426f-cc54-4d42-a05a-2da3c3059e26","name":"Race","shortName":"Race","shortCode":"Race","status":"","hasResults":true,"startTime":1742742000,"startTimeUtc":1742713200,"endTime":1742749200,"endTimeUtc":1742720400}]}]}`,
}

var classification = map[string]string{
	"8ebecded-edca-4521-bba3-aabfd89f45de": `{"details":[{"finishPosition":1,"gridPosition":2,"carNumber":"81","drivers":[{"name":"Oscar Piastri","firstName":"Oscar","lastName":"Piastri","shortCode":"PIAO","colour":null,"uuid":"6d2d46e8-d947-4311-a436-95fea51c2a1c","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-6d2d46e8-d947-4311-a436-95fea51c2a1c.jpg"}],"team":{"name":"McLaren Formula 1 Team","uuid":"bbdbb738-1b0b-4732-846b-10dc292b2f76","colour":"#FF9800","picture":"https://assets.motorsportstats.com/team/icon/teamColour_FF9800.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_FF9800.svg"},"nationality":{"name":"Australia","uuid":"5d247133-491d-4589-ab00-13d66211768b","picture":"https://assets.motorsportstats.com/flags/svg/au.svg"},"laps":50,"points":25,"time":4866758,"classifiedStatus":"CLA","avgLapSpeed":228.164,"fastestLapTime":92228,"gap":{"timeToLead":0,"timeToNext":0,"lapsToLead":0,"lapsToNext":0},"best":{"lap":50,"time":92228,"fastest":false,"speed":null}},{"finishPosition":2,"gridPosition":1,"carNumber":"1","drivers":[{"name":"Max Verstappen","firstName":"Max","lastName":"Verstappen","shortCode":"VER","colour":null,"uuid":"01e17884-0f97-4ce1-93b6-4de38b2a2445","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-01e17884-0f97-4ce1-93b6-4de38b2a2445.jpg"}],"team":{"name":"Oracle Red Bull Racing","uuid":"42ff413f-91b2-416b-b53f-cbfa77220a8a","colour":"#0600EF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_0600EF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_0600EF.svg"},"nationality":{"name":"Netherlands","uuid":"39d8585b-1e74-4280-923d-9d3457ef4f82","picture":"https://assets.motorsportstats.com/flags/svg/nl.svg"},"laps":50,"points":18,"time":4869601,"classifiedStatus":"CLA","avgLapSpeed":228.031,"fastestLapTime":92280,"gap":{"timeToLead":2843,"timeToNext":2843,"lapsToLead":0,"lapsToNext":0},"best":{"lap":49,"time":92280,"fastest":false,"speed":null}},{"finishPosition":3,"gridPosition":4,"carNumber":"16","drivers":[{"name":"Charles Leclerc","firstName":"Charles","lastName":"Leclerc","shortCode":"LEC","colour":null,"uuid":"8d5486d9-c622-4961-9f6e-9bb5b3ed14e1","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-8d5486d9-c622-4961-9f6e-9bb5b3ed14e1.jpg"}],"team":{"name":"Scuderia Ferrari HP","uuid":"142663c4-14f7-4c21-8609-882fdf4ab530","colour":"#DC0000","picture":"https://assets.motorsportstats.com/team/icon/teamColour_DC0000.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_DC0000.svg"},"nationality":{"name":"Monaco","uuid":"26863804-d54d-4811-b343-838dbdb62171","picture":"https://assets.motorsportstats.com/flags/svg/mc.svg"},"laps":50,"points":15,"time":4874862,"classifiedStatus":"CLA","avgLapSpeed":227.784,"fastestLapTime":92192,"gap":{"timeToLead":8104,"timeToNext":5261,"lapsToLead":0,"lapsToNext":0},"best":{"lap":49,"time":92192,"fastest":false,"speed":null}},{"finishPosition":4,"gridPosition":10,"carNumber":"4","drivers":[{"name":"Lando Norris","firstName":"Lando","lastName":"Norris","shortCode":"NORL","colour":null,"uuid":"7ad8ab0b-f7ed-4005-9052-8a3a81516a27","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-7ad8ab0b-f7ed-4005-9052-8a3a81516a27.jpg"}],"team":{"name":"McLaren Formula 1 Team","uuid":"bbdbb738-1b0b-4732-846b-10dc292b2f76","colour":"#FF9800","picture":"https://assets.motorsportstats.com/team/icon/teamColour_FF9800.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_FF9800.svg"},"nationality":{"name":"Great Britain","uuid":"5378198e-1d1e-49ef-bbc9-4e43383b4d3e","picture":"https://assets.motorsportstats.com/flags/svg/gb.svg"},"laps":50,"points":12,"time":4875954,"classifiedStatus":"CLA","avgLapSpeed":227.733,"fastestLapTime":91778,"gap":{"timeToLead":9196,"timeToNext":1092,"lapsToLead":0,"lapsToNext":0},"best":{"lap":41,"time":91778,"fastest":true,"speed":null}},{"finishPosition":5,"gridPosition":3,"carNumber":"63","drivers":[{"name":"George Russell","firstName":"George","lastName":"Russell","shortCode":"RUSG","colour":null,"uuid":"8f039358-b9b5-4bb3-b1cf-b4e60cd1a67a","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-8f039358-b9b5-4bb3-b1cf-b4e60cd1a67a.jpg"}],"team":{"name":"Mercedes-AMG Petronas Formula One Team","uuid":"f0110af5-a405-461c-bb8b-3e3d511bf7f8","colour":"#00D2BE","picture":"https://assets.motorsportstats.com/team/icon/teamColour_00D2BE.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_00D2BE.svg"},"nationality":{"name":"Great Britain","uuid":"5378198e-1d1e-49ef-bbc9-4e43383b4d3e","picture":"https://assets.motorsportstats.com/flags/svg/gb.svg"},"laps":50,"points":10,"time":4893994,"classifiedStatus":"CLA","avgLapSpeed":226.894,"fastestLapTime":92893,"gap":{"timeToLead":27236,"timeToNext":18040,"lapsToLead":0,"lapsToNext":0},"best":{"lap":32,"time":92893,"fastest":false,"speed":null}},{"finishPosition":6,"gridPosition":5,"carNumber":"12","drivers":[{"name":"Andrea Kimi Antonelli","firstName":"Andrea Kimi","lastName":"Antonelli","shortCode":"ANT","colour":null,"uuid":"265c6f21-fc98-4351-bdfa-194a68ec7a07","picture":null}],"team":{"name":"Mercedes-AMG Petronas Formula One Team","uuid":"f0110af5-a405-461c-bb8b-3e3d511bf7f8","colour":"#00D2BE","picture":"https://assets.motorsportstats.com/team/icon/teamColour_00D2BE.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_00D2BE.svg"},"nationality":{"name":"Italy","uuid":"d30d30d2-66b1-4959-b15a-660b3db331ea","picture":"https://assets.motorsportstats.com/flags/svg/it.svg"},"laps":50,"points":8,"time":4901446,"classifiedStatus":"CLA","avgLapSpeed":226.549,"fastestLapTime":92396,"gap":{"timeToLead":34688,"timeToNext":7452,"lapsToLead":0,"lapsToNext":0},"best":{"lap":50,"time":92396,"fastest":false,"speed":null}},{"finishPosition":7,"gridPosition":7,"carNumber":"44","drivers":[{"name":"Lewis Hamilton","firstName":"Lewis","lastName":"Hamilton","shortCode":"HAM","colour":"#00D2BE","uuid":"a39620e7-34c6-4b48-8160-62098f87d32b","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-a39620e7-34c6-4b48-8160-62098f87d32b.jpg"}],"team":{"name":"Scuderia Ferrari HP","uuid":"142663c4-14f7-4c21-8609-882fdf4ab530","colour":"#00D2BE","picture":"https://assets.motorsportstats.com/team/icon/teamColour_00D2BE.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_00D2BE.svg"},"nationality":{"name":"Great Britain","uuid":"5378198e-1d1e-49ef-bbc9-4e43383b4d3e","picture":"https://assets.motorsportstats.com/flags/svg/gb.svg"},"laps":50,"points":6,"time":4905831,"classifiedStatus":"CLA","avgLapSpeed":226.346,"fastestLapTime":92600,"gap":{"timeToLead":39073,"timeToNext":4385,"lapsToLead":0,"lapsToNext":0},"best":{"lap":43,"time":92600,"fastest":false,"speed":null}},{"finishPosition":8,"gridPosition":6,"carNumber":"55","drivers":[{"name":"Carlos Sainz","firstName":"Carlos","lastName":"Sainz","shortCode":"SAI","colour":null,"uuid":"458bf697-7fb6-41cd-bbbe-15a6b39ed4e3","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-458bf697-7fb6-41cd-bbbe-15a6b39ed4e3.jpg"}],"team":{"name":"Atlassian Williams Racing","uuid":"4d5a3a4d-2dd6-446a-96fd-9055206f58a9","colour":"#005AFF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_005AFF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_005AFF.svg"},"nationality":{"name":"Spain","uuid":"92334886-6536-401f-9ba2-4677c4fbd0ca","picture":"https://assets.motorsportstats.com/flags/svg/es.svg"},"laps":50,"points":4,"time":4931388,"classifiedStatus":"CLA","avgLapSpeed":225.173,"fastestLapTime":92466,"gap":{"timeToLead":64630,"timeToNext":25557,"lapsToLead":0,"lapsToNext":0},"best":{"lap":50,"time":92466,"fastest":false,"speed":null}},{"finishPosition":9,"gridPosition":11,"carNumber":"23","drivers":[{"name":"Alexander Albon","firstName":"Alexander","lastName":"Albon","shortCode":"ALBA","colour":null,"uuid":"2a6c4196-ab5f-4850-bac2-03ff42ae6a34","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-2a6c4196-ab5f-4850-bac2-03ff42ae6a34.jpg"}],"team":{"name":"Atlassian Williams Racing","uuid":"4d5a3a4d-2dd6-446a-96fd-9055206f58a9","colour":"#005AFF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_005AFF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_005AFF.svg"},"nationality":{"name":"Thailand","uuid":"b78d9fd4-3a67-4342-95d0-d466098eb0fd","picture":"https://assets.motorsportstats.com/flags/svg/th.svg"},"laps":50,"points":2,"time":4933273,"classifiedStatus":"CLA","avgLapSpeed":225.087,"fastestLapTime":93477,"gap":{"timeToLead":66515,"timeToNext":1885,"lapsToLead":0,"lapsToNext":0},"best":{"lap":47,"time":93477,"fastest":false,"speed":null}},{"finishPosition":10,"gridPosition":14,"carNumber":"6","drivers":[{"name":"Isack Hadjar","firstName":"Isack","lastName":"Hadjar","shortCode":"HADJ","colour":null,"uuid":"24fbe72a-083b-4940-bac6-7aacf7ba2036","picture":null}],"team":{"name":"Visa Cash App Racing Bulls Formula One Team","uuid":"c3596e64-8f70-4d3e-9bbd-daff75d03042","colour":"#FF9912","picture":"https://assets.motorsportstats.com/team/icon/teamColour_FF9912.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_FF9912.svg"},"nationality":{"name":"France","uuid":"20ad68e8-be3b-4540-9549-4b03c635f7d9","picture":"https://assets.motorsportstats.com/flags/svg/fr.svg"},"laps":50,"points":1,"time":4933849,"classifiedStatus":"CLA","avgLapSpeed":225.061,"fastestLapTime":93257,"gap":{"timeToLead":67091,"timeToNext":576,"lapsToLead":0,"lapsToNext":0},"best":{"lap":39,"time":93257,"fastest":false,"speed":null}},{"finishPosition":11,"gridPosition":13,"carNumber":"14","drivers":[{"name":"Fernando Alonso","firstName":"Fernando","lastName":"Alonso","shortCode":"ALO","colour":null,"uuid":"985d7eec-3c7b-4153-a189-1dd1b72538cc","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-985d7eec-3c7b-4153-a189-1dd1b72538cc.jpg"}],"team":{"name":"Aston Martin Aramco Formula One Team","uuid":"7e1df0d5-269b-430f-978f-c87f77c9b295","colour":"#006F62","picture":"https://assets.motorsportstats.com/team/icon/teamColour_006F62.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_006F62.svg"},"nationality":{"name":"Spain","uuid":"92334886-6536-401f-9ba2-4677c4fbd0ca","picture":"https://assets.motorsportstats.com/flags/svg/es.svg"},"laps":50,"points":0,"time":4942675,"classifiedStatus":"CLA","avgLapSpeed":224.659,"fastestLapTime":93009,"gap":{"timeToLead":75917,"timeToNext":8826,"lapsToLead":0,"lapsToNext":0},"best":{"lap":49,"time":93009,"fastest":false,"speed":null}},{"finishPosition":12,"gridPosition":12,"carNumber":"30","drivers":[{"name":"Liam Lawson","firstName":"Liam","lastName":"Lawson","shortCode":"LAW","colour":null,"uuid":"304db7f2-70e5-40c9-a93d-702d45b732d5","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-304db7f2-70e5-40c9-a93d-702d45b732d5.jpg"}],"team":{"name":"Visa Cash App Racing Bulls Formula One Team","uuid":"c3596e64-8f70-4d3e-9bbd-daff75d03042","colour":"#FF9912","picture":"https://assets.motorsportstats.com/team/icon/teamColour_FF9912.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_FF9912.svg"},"nationality":{"name":"New Zealand","uuid":"8d7aa3bf-f5f2-4688-b888-a6b561b7cbd9","picture":"https://assets.motorsportstats.com/flags/svg/nz.svg"},"laps":50,"points":0,"time":4945209,"classifiedStatus":"CLA","avgLapSpeed":224.544,"fastestLapTime":92998,"gap":{"timeToLead":78451,"timeToNext":2534,"lapsToLead":0,"lapsToNext":0},"best":{"lap":43,"time":92998,"fastest":false,"speed":null}},{"finishPosition":13,"gridPosition":15,"carNumber":"87","drivers":[{"name":"Oliver Bearman","firstName":"Oliver","lastName":"Bearman","shortCode":"BEA","colour":null,"uuid":"b9466969-cd8f-409c-97f5-d207ef466a36","picture":null}],"team":{"name":"MoneyGram Haas F1 Team","uuid":"bb1f63c5-52b2-47e1-a534-6fd61a76880f","colour":"#FFFFFF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_FFFFFF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_FFFFFF.svg"},"nationality":{"name":"Great Britain","uuid":"5378198e-1d1e-49ef-bbc9-4e43383b4d3e","picture":"https://assets.motorsportstats.com/flags/svg/gb.svg"},"laps":50,"points":0,"time":4945952,"classifiedStatus":"CLA","avgLapSpeed":224.51,"fastestLapTime":93238,"gap":{"timeToLead":79194,"timeToNext":743,"lapsToLead":0,"lapsToNext":0},"best":{"lap":50,"time":93238,"fastest":false,"speed":null}},{"finishPosition":14,"gridPosition":19,"carNumber":"31","drivers":[{"name":"Esteban Ocon","firstName":"Esteban","lastName":"Ocon","shortCode":"OCO","colour":null,"uuid":"c2d31132-e951-4332-8da5-537be5951073","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-c2d31132-e951-4332-8da5-537be5951073.jpg"}],"team":{"name":"MoneyGram Haas F1 Team","uuid":"bb1f63c5-52b2-47e1-a534-6fd61a76880f","colour":"#FFFFFF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_FFFFFF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_FFFFFF.svg"},"nationality":{"name":"France","uuid":"20ad68e8-be3b-4540-9549-4b03c635f7d9","picture":"https://assets.motorsportstats.com/flags/svg/fr.svg"},"laps":50,"points":0,"time":4966481,"classifiedStatus":"CLA","avgLapSpeed":223.582,"fastestLapTime":94309,"gap":{"timeToLead":99723,"timeToNext":20529,"lapsToLead":0,"lapsToNext":0},"best":{"lap":47,"time":94309,"fastest":false,"speed":null}},{"finishPosition":15,"gridPosition":18,"carNumber":"27","drivers":[{"name":"Nico Hülkenberg","firstName":"Nico","lastName":"Hülkenberg","shortCode":"HUL","colour":null,"uuid":"6a39a910-833f-40a8-87b7-4a53a7b9cdb5","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-6a39a910-833f-40a8-87b7-4a53a7b9cdb5.jpg"}],"team":{"name":"Stake F1 Team Kick Sauber","uuid":"530a4357-e852-4faa-8489-781fc68f1c15","colour":"#006EFF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_006EFF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_006EFF.svg"},"nationality":{"name":"Germany","uuid":"c9018443-af50-4f5f-be39-3d9682a6838e","picture":"https://assets.motorsportstats.com/flags/svg/de.svg"},"laps":49,"points":0,"time":4871367,"classifiedStatus":"CLA","avgLapSpeed":223.385,"fastestLapTime":93446,"gap":{"timeToLead":0,"timeToNext":0,"lapsToLead":1,"lapsToNext":1},"best":{"lap":39,"time":93446,"fastest":false,"speed":null}},{"finishPosition":16,"gridPosition":16,"carNumber":"18","drivers":[{"name":"Lance Stroll","firstName":"Lance","lastName":"Stroll","shortCode":"STR","colour":null,"uuid":"3305223c-dab1-4a0a-b818-660565378791","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-3305223c-dab1-4a0a-b818-660565378791.jpg"}],"team":{"name":"Aston Martin Aramco Formula One Team","uuid":"7e1df0d5-269b-430f-978f-c87f77c9b295","colour":"#006F62","picture":"https://assets.motorsportstats.com/team/icon/teamColour_006F62.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_006F62.svg"},"nationality":{"name":"Canada","uuid":"b2180b61-398e-47b0-9ad7-2f273d3fef0b","picture":"https://assets.motorsportstats.com/flags/svg/ca.svg"},"laps":49,"points":0,"time":4872285,"classifiedStatus":"CLA","avgLapSpeed":223.343,"fastestLapTime":92745,"gap":{"timeToLead":0,"timeToNext":918,"lapsToLead":1,"lapsToNext":0},"best":{"lap":44,"time":92745,"fastest":false,"speed":null}},{"finishPosition":17,"gridPosition":17,"carNumber":"7","drivers":[{"name":"Jack Doohan","firstName":"Jack","lastName":"Doohan","shortCode":"DOO","colour":null,"uuid":"1ec645a6-8304-4773-8a48-62979672e9c1","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-1ec645a6-8304-4773-8a48-62979672e9c1.jpg"}],"team":{"name":"BWT Alpine F1 Team","uuid":"afe9870a-4c9a-4b7d-8056-daad49dee3f0","colour":"#0090FF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_0090FF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_0090FF.svg"},"nationality":{"name":"Australia","uuid":"5d247133-491d-4589-ab00-13d66211768b","picture":"https://assets.motorsportstats.com/flags/svg/au.svg"},"laps":49,"points":0,"time":4886022,"classifiedStatus":"CLA","avgLapSpeed":222.715,"fastestLapTime":93150,"gap":{"timeToLead":0,"timeToNext":13737,"lapsToLead":1,"lapsToNext":0},"best":{"lap":48,"time":93150,"fastest":false,"speed":null}},{"finishPosition":18,"gridPosition":20,"carNumber":"5","drivers":[{"name":"Gabriel Bortoleto","firstName":"Gabriel","lastName":"Bortoleto","shortCode":"BOR","colour":null,"uuid":"7628e584-7374-45b5-a80f-86d9f5f5c761","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-7628e584-7374-45b5-a80f-86d9f5f5c761.jpg"}],"team":{"name":"Stake F1 Team Kick Sauber","uuid":"530a4357-e852-4faa-8489-781fc68f1c15","colour":"#006EFF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_006EFF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_006EFF.svg"},"nationality":{"name":"Brazil","uuid":"9d528a15-ffb1-4911-bcdf-2ac4d4adc12b","picture":"https://assets.motorsportstats.com/flags/svg/br.svg"},"laps":49,"points":0,"time":4886064,"classifiedStatus":"CLA","avgLapSpeed":222.713,"fastestLapTime":94447,"gap":{"timeToLead":0,"timeToNext":42,"lapsToLead":1,"lapsToNext":0},"best":{"lap":39,"time":94447,"fastest":false,"speed":null}},{"finishPosition":0,"gridPosition":8,"carNumber":"22","drivers":[{"name":"Yuki Tsunoda","firstName":"Yuki","lastName":"Tsunoda","shortCode":"TSU","colour":null,"uuid":"5592bc19-3695-4f36-b12c-5c82bbb586be","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-5592bc19-3695-4f36-b12c-5c82bbb586be.jpg"}],"team":{"name":"Oracle Red Bull Racing","uuid":"42ff413f-91b2-416b-b53f-cbfa77220a8a","colour":"#0600EF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_0600EF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_0600EF.svg"},"nationality":{"name":"Japan","uuid":"c8e16024-7a03-4dce-86a5-67b49a5c8693","picture":"https://assets.motorsportstats.com/flags/svg/jp.svg"},"laps":1,"points":0,"time":165662,"classifiedStatus":"DNF","avgLapSpeed":128.734,"fastestLapTime":0,"gap":{"timeToLead":0,"timeToNext":0,"lapsToLead":49,"lapsToNext":48},"best":{"lap":0,"time":0,"fastest":false,"speed":0}},{"finishPosition":0,"gridPosition":9,"carNumber":"10","drivers":[{"name":"Pierre Gasly","firstName":"Pierre","lastName":"Gasly","shortCode":"GAS","colour":null,"uuid":"7c13a1b1-029d-4d59-80ad-861a17b16872","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-7c13a1b1-029d-4d59-80ad-861a17b16872.jpg"}],"team":{"name":"BWT Alpine F1 Team","uuid":"afe9870a-4c9a-4b7d-8056-daad49dee3f0","colour":"#0090FF","picture":"https://assets.motorsportstats.com/team/icon/teamColour_0090FF.svg","carIcon":"https://assets.motorsportstats.com/carIcon/Default/caricon_RaceCar_0090FF.svg"},"nationality":{"name":"France","uuid":"20ad68e8-be3b-4540-9549-4b03c635f7d9","picture":"https://assets.motorsportstats.com/flags/svg/fr.svg"},"laps":0,"points":0,"time":0,"classifiedStatus":"DNF","avgLapSpeed":0,"fastestLapTime":0,"gap":{"timeToLead":0,"timeToNext":0,"lapsToLead":50,"lapsToNext":1},"best":{"lap":0,"time":0,"fastest":false,"speed":0}}],"retirements":[{"driver":{"name":"Yuki Tsunoda","firstName":"Yuki","lastName":"Tsunoda","shortCode":"TSU","colour":null,"uuid":"5592bc19-3695-4f36-b12c-5c82bbb586be","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-5592bc19-3695-4f36-b12c-5c82bbb586be.jpg"},"carNumber":"22","reason":"Accident","type":"Accident","dns":false,"lap":1,"details":null},{"driver":{"name":"Pierre Gasly","firstName":"Pierre","lastName":"Gasly","shortCode":"GAS","colour":null,"uuid":"7c13a1b1-029d-4d59-80ad-861a17b16872","picture":"https://content.motorsportstats.com/medium/driverProfilePicture/driverProfilePicture-7c13a1b1-029d-4d59-80ad-861a17b16872.jpg"},"carNumber":"10","reason":"Accident","type":"Accident","dns":false,"lap":0,"details":null}]}`,
}

func NewTestServer() *httptest.Server {
	return httptest.NewServer(
		http.HandlerFunc(serve),
	)
}

func ConnectorForTestServer(server *httptest.Server) *ConnectorUsingClient {
	return NewConnectorUsingClient(client.NewClient(server.URL))
}

func serve(w http.ResponseWriter, r *http.Request) {
	if r.Method != "GET" {
		http.Error(w, "Method not allowed", http.StatusMethodNotAllowed)
		return
	}

	if r.Header.Get("Origin") != "https://widgets.motorsportstats.com" ||
		r.Header.Get("X-Parent-Referer") != "https://motorsportstats.com/" {
		http.Error(w, "Origin not allowed", http.StatusForbidden)
		return
	}

	for _, route := range routes {
		matches := route.regex.FindSubmatch([]byte(r.URL.Path))
		if len(matches) > 0 {
			ctx := context.WithValue(r.Context(), ctxKey{}, matches[1:])
			route.handler(w, r.WithContext(ctx))
			return
		}
	}
}

var routes = []route{
	newRoute("/widgets/1.0.0/series", seriesHandler),
	newRoute("/widgets/1.0.0/series/([^/]+)/seasons", seasonsHandler),
	newRoute("/widgets/1.0.0/seasons/([^/]+)/calendar", calendarHandler),
	newRoute("/widgets/1.0.0/sessions/([^/]+)/classification", classificationHandler),
}

func newRoute(pattern string, handler http.HandlerFunc) route {
	return route{regexp.MustCompile("^" + pattern + "$"), handler}
}

type route struct {
	regex   *regexp.Regexp
	handler http.HandlerFunc
}

type ctxKey struct{}

func getField(r *http.Request, index int) string {
	fields, ok := r.Context().Value(ctxKey{}).([][]byte)
	if !ok || index >= len(fields) {
		return ""
	}

	return string(fields[index])
}

func seriesHandler(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(http.StatusOK)
	_, _ = w.Write([]byte(series))
}

func seasonsHandler(w http.ResponseWriter, r *http.Request) {
	seriesUUID := getField(r, 0)

	data, exists := seasons[seriesUUID]
	if !exists {
		http.Error(w, "Series not found", http.StatusNotFound)
		return
	}

	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(http.StatusOK)
	_, _ = w.Write([]byte(data))
}

func calendarHandler(w http.ResponseWriter, r *http.Request) {
	seasonUUID := getField(r, 0)

	data, exists := calendar[seasonUUID]
	if !exists {
		http.Error(w, "Season not found", http.StatusNotFound)
		return
	}

	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(http.StatusOK)
	_, _ = w.Write([]byte(data))
}

func classificationHandler(w http.ResponseWriter, r *http.Request) {
	sessionUUID := getField(r, 0)

	data, exists := classification[sessionUUID]
	if exists == false {
		http.Error(w, "Session not found", http.StatusNotFound)
		return
	}

	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(http.StatusOK)
	_, _ = w.Write([]byte(data))
}
